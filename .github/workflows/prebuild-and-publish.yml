name: Build prebuilt binaries

on:
  push:
    tags:
      - "v*"

jobs:
  prebuilds:
    strategy:
      fail-fast: false
      matrix:
        include:
          - os: ubuntu-latest
            arch: x64
          - os: macos-14
            arch: arm64
    runs-on: ${{ matrix.os }}

    steps:
      - uses: actions/checkout@v4
      - name: Use Node.js ${{ matrix.node-version }}
        uses: actions/setup-node@v4
        with:
          node-version: 22
      - name: Install system deps (Linux only)
        if: runner.os == 'Linux'
        run: |
          sudo apt-get update
          sudo apt-get install -y \
            build-essential pkg-config cmake git \
            libleptonica-dev \
            libpng-dev libjpeg-dev libtiff-dev zlib1g-dev \
            libwebp-dev libopenjp2-7-dev
      - name: Build and install Tesseract 5.5.2 from source (Linux only)
        if: runner.os == 'Linux'
        shell: bash
        run: |
          set -euo pipefail
          git clone --depth 1 --branch 5.5.2 https://github.com/tesseract-ocr/tesseract.git /tmp/tesseract-src
          cmake -S /tmp/tesseract-src -B /tmp/tesseract-src/build \
            -DCMAKE_BUILD_TYPE=Release \
            -DBUILD_SHARED_LIBS=ON \
            -DCMAKE_POSITION_INDEPENDENT_CODE=ON \
            -DBUILD_TRAINING_TOOLS=OFF \
            -DBUILD_TESTS=OFF
          cmake --build /tmp/tesseract-src/build -j"$(nproc)"
          sudo cmake --install /tmp/tesseract-src/build
          sudo ldconfig
      - name: Install system deps (macOS only)
        if: runner.os == 'macOS'
        run: |
          brew update
          brew install tesseract leptonica pkg-config llvm
      - name: Verify Tesseract version (exactly 5.5.2)
        shell: bash
        run: |
          set -euo pipefail
          tess_version="$(pkg-config --modversion tesseract || true)"
          echo "Detected tesseract version: ${tess_version:-<none>}"

          if [[ "$tess_version" != "5.5.2" ]]; then
            echo "::error::Expected tesseract 5.5.2, but found '${tess_version:-unknown}'."
            exit 1
          fi
      - name: Install deps
        run: npm ci --ignore-scripts
      - name: Build addon
        env:
          npm_config_arch: ${{ matrix.arch }}
          CC: ${{ runner.os == 'macOS' && format('{0}/opt/llvm/bin/clang', env.HOMEBREW_PREFIX) || '' }}
          CXX: ${{ runner.os == 'macOS' && format('{0}/opt/llvm/bin/clang++', env.HOMEBREW_PREFIX) || '' }}
        run: |
          # Resolve brew prefix reliably (covers /opt/homebrew and /usr/local)
          if [[ "$RUNNER_OS" == "macOS" ]]; then
            BREW_PREFIX="$(brew --prefix)"
            export CC="$BREW_PREFIX/opt/llvm/bin/clang"
            export CXX="$BREW_PREFIX/opt/llvm/bin/clang++"
            export CMAKE_C_COMPILER="$CC"
            export CMAKE_CXX_COMPILER="$CXX"

            export SDKROOT="$(xcrun --sdk macosx --show-sdk-path)"

            # Often helpful for picking Brew libc++/headers consistently
            export CPPFLAGS="-I$BREW_PREFIX/opt/llvm/include"
            export LDFLAGS="-L$BREW_PREFIX/opt/llvm/lib"
          fi

          npx cmake-js compile --release \
            --CD CMAKE_OSX_SYSROOT="$SDKROOT" \
            --CD CMAKE_C_COMPILER="$CC" \
            --CD CMAKE_CXX_COMPILER="$CXX"
      - name: Copy into prebuilds/ (pkg-prebuilds-copy)
        shell: bash
        run: |
          set -euo pipefail
          node_file="$(find build -type f -name "*.node" | head -n 1)"
          test -n "$node_file"
          base_dir="$(dirname "$node_file")"
          file_name="$(basename "$node_file")"

          npx pkg-prebuilds-copy \
            --baseDir "$base_dir" \
            --source "$file_name" \
            --name "node-tesseract-ocr" \
            --napi_version 10 \
            --strip \
            --arch "${{ matrix.arch }}"

      - name: Upload prebuilds
        uses: actions/upload-artifact@v4
        with:
          name: prebuilds-${{ matrix.os }}-${{ matrix.arch }}
          path: prebuilds/
          if-no-files-found: error

  publish:
    needs: prebuilds
    runs-on: ubuntu-latest
    permissions:
      contents: write

    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-node@v4
        with:
          node-version: 22
          registry-url: https://registry.npmjs.org
      - name: Download prebuild artifacts
        uses: actions/download-artifact@v4
        with:
          path: prebuilds-merged
      - name: Merge prebuilds folders
        run: |
          mkdir -p prebuilds
          find prebuilds-merged -type f -name "*.node" -exec bash -c '
            for f; do
              platform_dir="$(basename "$(dirname "$f")")"
              filename="$(basename "$f")"
              mkdir -p "prebuilds/$platform_dir"
              cp "$f" "prebuilds/$platform_dir/$filename"
            done
          ' bash {} +

      - name: Zip merged prebuilds
        run: |
          zip -r prebuilds-${{ github.ref_name }}.zip prebuilds

      - name: Install dependencies
        run: npm ci --include=dev --ignore-scripts

      - name: Build TypeScript
        run: npm run build:ts

      - name: Create GitHub Release and upload assets
        uses: softprops/action-gh-release@v2
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          tag_name: ${{ github.ref_name }}
          name: Release ${{ github.ref_name }}
          files: |
            prebuilds-${{ github.ref_name }}.zip

      - name: Check package contents
        run: npm pack

      - name: Publish to npm
        run: npm publish --access public
        env:
          NODE_AUTH_TOKEN: ${{ secrets.NPM_TOKEN }}
